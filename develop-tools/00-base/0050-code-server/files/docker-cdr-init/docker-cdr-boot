#!/bin/bash
set -o errexit

echo "*** Development environment with code-server ***"

# backup previous version's extensions
if [ -d "/data/home/.local/share/code-server/extensions/" ]; then
	if [ ! -d "/data/home/.local/share/code-server/extensions.BF${CODE_SERVER_VER}/" ]; then
		echo "... Backup previous version's extensions INTO '/data/home/.local/share/code-server/extensions.BF${CODE_SERVER_VER}/' ..."
		mv "/data/home/.local/share/code-server/extensions/" "/data/home/.local/share/code-server/extensions.BF${CODE_SERVER_VER}/"
	fi
fi

# extensions initialization - child image should install or copy extensions here
if [ ! -d "/data/home/.local/share/code-server/extensions/" ]; then
	# ONLY a BLANK ~/.config/code-server need extensions initialization
	mkdir -p /data/home/.local/share/code-server/extensions
	
	# Install pre-installed extensions
    /docker-cdr-init/docker-cdr-install-extensions.sh

    echo "... First boot - setting up ownership for u01 :'/data/home/.local/' ..."
    echo ".... --------"
	chown -Rv u01:u01 /data/home/.local/ | (sed -u 7q; echo "..."; tail -n 7)
    echo ".... --------"
fi

echo "... Extensions installed at '/data/home/.local/share/code-server/extensions':"
echo ".... --------"
ls -al "/data/home/.local/share/code-server/extensions/"
echo ".... --------"
